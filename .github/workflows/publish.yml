name: Publish to pub.dev

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'

      - name: Setup pub.dev credentials
        uses: flutter-actions/setup-pubdev-credentials@v1

      - name: Publish to pub.dev
        run: flutter pub publish --force

      - name: Discord notification (success)
        if: success()
        run: |
          curl -H "Content-Type: application/json" -X POST -d '{
            "embeds": [{
              "title": "✅ Flutter SDK published to pub.dev",
              "description": "Version `${{ github.ref_name }}` published successfully",
              "color": 5025616,
              "url": "https://pub.dev/packages/mostly_good_metrics_flutter"
            }]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Discord notification (failure)
        if: failure()
        run: |
          curl -H "Content-Type: application/json" -X POST -d '{
            "embeds": [{
              "title": "❌ Flutter SDK publish failed",
              "description": "Version `${{ github.ref_name }}` failed to publish to pub.dev",
              "color": 15158332,
              "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}
